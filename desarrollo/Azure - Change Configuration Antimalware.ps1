$BD_Luck = Import-Csv E:\Users\Rodolfo\Desktop\Azure\lucky.csv

# Script to add Microsoft Antimalware extension to Azure Resource Manager (IAAS V2) VM’s
# Specify your subscription ID
$subscriptionId= “f2d03dd4-a65b-4b0f-a956-441ee6fcc910”

# Login to your Azure Resource Manager Account and select the Subscription to use
Login-AzureRmAccount
Select-AzureRmSubscription -SubscriptionId $subscriptionId

foreach($VM in $BD_Luck){
# specify location, resource group, and VM for the extension
$location = “East US” # eg., “Southeast Asia” or “Central US”
$resourceGroupName = $VM.RGroup
$vmName = $VM.VMName
Write-Host 'Working on' $vmName 'of the' $resourceGroupName 'resource Group'
# Configuration.JSON configuration file can be customized as per MSDN documentation: https://msdn.microsoft.com/en-us/library/dn771716.aspx
$settingString = ‘{
          "AntimalwareEnabled": true,
          "RealtimeProtectionEnabled": "true",
          "ScheduledScanSettings": {
            "isEnabled": "true",
            "day": "0",
            "time": "0",
            "scanType": "Quick"
          },
          "Exclusions": {
            "Extensions": "",
            "Paths": "C:\\inetpub;C:\\Program Files\\Microsoft SQL Server",
            "Processes": ""
          }
        }'

# retrieve the most recent version number of the extension
$allVersions= (Get-AzureRmVMExtensionImage -Location $location -PublisherName “Microsoft.Azure.Security” -Type “IaaSAntimalware”).Version
$versionString = $allVersions[($allVersions.count)-1].Split(“.”)[0] + “.” + $allVersions[($allVersions.count)-1].Split(“.”)[1]
# set the extension using prepared values
# ****—-Use this script till cmdlets address the -SettingsString format issue we observed ****—-
Set-AzureRmVMExtension -ResourceGroupName $resourceGroupName -Location $location -VMName $vmName -Name “IaaSAntimalware” -Publisher “Microsoft.Azure.Security” -ExtensionType “IaaSAntimalware” -TypeHandlerVersion $versionString -SettingString $settingString
}